---
title: "chp3"
author: "Vasco Braz√£o"
date: "12/5/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
```{r packages}
library(tidyverse)
library(rethinking)
```

Code for the easy problems (from book):

```{r easy.samples}

p_grid <- seq( from=0 , to=1 , length.out=1000 )
prior <- rep( 1 , 1000 )
likelihood <- dbinom( 6 , size=9 , prob=p_grid )
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)

set.seed(100)

samples <- sample(p_grid, prob = posterior, size = 1e4, replace = TRUE)
```

## 3E1

```{r 3e1}
sum(samples < .2) / length(samples)
```
## 3E2

```{r 3e2}
sum(samples > .8) / length(samples)
```
## 3E3

```{r 3e3}
(sum(samples > .2) - sum(samples >= .8))/ length(samples)
```
## 3E4

```{r 3e4}
quantile(samples, .2)
```
## 3E5

```{r 3e5}
quantile(samples, .8)
```
## 3E6

```{r 3e6}
rethinking::HPDI(samples, .66)
```

## 3E7

```{r 3e7}
rethinking::PI(samples, .66)
```
## 3M1
This time trying to be a little more tidyverse-y
```{r 3m1}
globe <- tibble(
  p_grid = seq(from = 0, to = 1, length.out = 1000),
  prior = rep(1, 1000),
  likelihood = dbinom(8, size = 15, prob = p_grid),
  posterior = likelihood * prior / sum(likelihood * prior)
)

#a graph for good measure

globe3m1post <- globe %>%
  ggplot(aes(x = p_grid, y = posterior)) +
  geom_line()

print(globe3m1post)
```

## 3M2

```{r 3m2}
set.seed(100)

samples <- sample(globe$p_grid, prob = globe$posterior, size = 1e4, replace = TRUE)

rethinking::HPDI(samples, .90)
```

## 3M3

```{r 3m3}
w <- rbinom(1e4, size = 15, prob=samples)

# probability of 8 W
sum(w == 8)/1e4
```
## 3M4

```{r 3m4}
new_w <- rbinom(1e4, size = 9, prob = samples)

# probability of 6 w
sum(new_w == 6)/1e4

```

## 3M5
```{r 3m5}
# first, we create the data again
globe_new <- tibble(
  p_grid = seq(from = 0, to = 1, length.out = 1000),
  prior = ifelse(p_grid >= .5, 1, 0),
  likelihood = dbinom(8, size = 15, prob = p_grid),
  posterior = likelihood * prior / sum(likelihood * prior)
)

# graph

globe3m5post <- globe_new %>%
  ggplot(aes(x = p_grid, y = posterior)) +
  geom_line()

print(globe3m5post)
```
To calculate de hpdi

```{r 3m5.hpdi}
set.seed(100)

samples <- sample(globe_new$p_grid, prob = globe_new$posterior, size = 1e4, replace = TRUE)

rethinking::HPDI(samples, .90)
```

We can see it is quite a bit narrower, and now confidently excludes values below .5. The upper bound did not shrink by a lot though.

For the posterior predictive check: what does our model think is the probability of observing 8 waters in 15 tosses?

```{r 3m5.ppc}
w <- rbinom(1e4, size = 15, prob = samples)

# probability of 8 W
sum(w == 8)/1e4
```

It is a little lower than before.

Now for 6 waters in 9 tosses.

```{r 3m5.sixwaters}
new_w <- rbinom(1e4, size = 9, prob = samples)

# probability of 6 w
sum(new_w == 6)/1e4
```

It is a little higher than before.

All in all, the model performs a bit better.

## 3M6

This one looks fun! Not sure if there is an easy way to do it, but I will try some brute force I suppose. Will also help me brush up on functions and simulations and whatnot, I guess.

```{r 3m6}
pi_width <- function(tosses = 20){
  # the amount of waters we observe is random, but depends on the true proportion
  # which we take to be .7
  waters <- rbinom(1, size = tosses, prob = .7)
  
  # now we can construct the posterior, using first the flat prior
  globe_pos <- tibble(
    p_grid = seq(from = 0, to = 1, length.out = 1000),
    prior = rep(1, 1000),
    likelihood = dbinom(waters, size = tosses, prob = p_grid),
    posterior = likelihood * prior / sum(likelihood * prior)
  )
  
  # then we sample from the posterior
  pos_samples <- sample(globe_pos$p_grid, 
                        prob = globe_pos$posterior, 
                        size = 1e4, replace = TRUE)
  
  # now we feed the samples to the PI function
  interval <- rethinking::PI(pos_samples, .99)
  
  # this is what we want to minimize, what our function will return
  width <- interval[[2]] - interval[[1]]
  
  return(width)
}


```
